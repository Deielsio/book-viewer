<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Editor</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body style="margin: 0; padding: 0;">
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const Upload = ({ size, style }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={style}>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
            </svg>
        );

        const FileText = ({ size, style }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={style}>
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10 9 9 9 8 9"/>
            </svg>
        );

        const ZoomIn = ({ size }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35M11 8v6M8 11h6"/>
            </svg>
        );

        const ZoomOut = ({ size }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35M8 11h6"/>
            </svg>
        );

        const AlertCircle = ({ size, style }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={style}>
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
        );

        const Save = ({ size }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                <polyline points="17 21 17 13 7 13 7 21"/>
                <polyline points="7 3 7 8 15 8"/>
            </svg>
        );

        const Copy = ({ size }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
            </svg>
        );

        const Printer = ({ size }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="6 9 6 2 18 2 18 9"/>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                <rect x="6" y="14" width="12" height="8"/>
            </svg>
        );

        const FolderOpen = ({ size }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
            </svg>
        );

        const BookViewer = () => {
            const [file, setFile] = useState(null);
            const [content, setContent] = useState('');
            const [loading, setLoading] = useState(false);
            const [zoom, setZoom] = useState(100);
            const [fileType, setFileType] = useState('');
            const [error, setError] = useState('');
            const [showUpload, setShowUpload] = useState(false);

            const loadJSZip = () => {
                return new Promise((resolve, reject) => {
                    if (window.JSZip) {
                        resolve(window.JSZip);
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                    script.onload = () => resolve(window.JSZip);
                    script.onerror = () => reject(new Error('Failed to load JSZip library'));
                    document.head.appendChild(script);
                });
            };

            const handleFileUpload = async (e) => {
                const uploadedFile = e.target.files[0];
                if (!uploadedFile) return;

                setLoading(true);
                setFile(uploadedFile);
                setError('');
                setContent('');
                setShowUpload(false);
                
                const fileName = uploadedFile.name.toLowerCase();
                const type = uploadedFile.type;
                setFileType(type);

                try {
                    if (fileName.endsWith('.pdf') || type === 'application/pdf') {
                        await handlePDF(uploadedFile);
                    } else if (fileName.endsWith('.epub') || type === 'application/epub+zip') {
                        await handleEPUB(uploadedFile);
                    } else {
                        throw new Error('Unsupported file type. Please upload a PDF or EPUB file.');
                    }
                } catch (error) {
                    console.error('Error loading file:', error);
                    setError(`Error: ${error.message || 'Could not load file. Please try a different file.'}`);
                    setContent('');
                }
                
                setLoading(false);
            };

            const handlePDF = async (file) => {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);
                    
                    let binary = '';
                    const chunkSize = 8192;
                    for (let i = 0; i < uint8Array.length; i += chunkSize) {
                        const chunk = uint8Array.subarray(i, Math.min(i + chunkSize, uint8Array.length));
                        binary += String.fromCharCode.apply(null, chunk);
                    }
                    const base64 = btoa(binary);
                    
                    setContent(`
                        <div style="width: 100%; height: 100%; display: flex; justify-content: center;">
                            <embed 
                                src="data:application/pdf;base64,${base64}" 
                                type="application/pdf" 
                                width="100%" 
                                height="700px"
                                style="border: none;"
                            />
                        </div>
                    `);
                } catch (err) {
                    throw new Error('Failed to load PDF file. The file may be corrupted or too large.');
                }
            };

            const handleEPUB = async (file) => {
                try {
                    const JSZip = await loadJSZip();
                    
                    const arrayBuffer = await file.arrayBuffer();
                    const zip = await JSZip.loadAsync(arrayBuffer);
                    
                    let htmlContent = '';
                    
                    const possiblePaths = [
                        'OEBPS/content.opf',
                        'OPS/content.opf', 
                        'EPUB/content.opf',
                        'content.opf'
                    ];
                    
                    let contentOpf = null;
                    for (const path of possiblePaths) {
                        try {
                            contentOpf = await zip.file(path)?.async('string');
                            if (contentOpf) break;
                        } catch (e) {
                            continue;
                        }
                    }
                    
                    if (contentOpf) {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(contentOpf, 'text/xml');
                        const manifest = doc.querySelectorAll('manifest item[media-type*="html"]');
                        
                        for (let item of manifest) {
                            const href = item.getAttribute('href');
                            if (!href) continue;
                            
                            const basePaths = ['OEBPS/', 'OPS/', 'EPUB/', ''];
                            let fileContent = null;
                            
                            for (const basePath of basePaths) {
                                try {
                                    fileContent = await zip.file(basePath + href)?.async('string');
                                    if (fileContent) break;
                                } catch (e) {
                                    continue;
                                }
                            }
                            
                            if (fileContent) {
                                const contentDoc = parser.parseFromString(fileContent, 'text/html');
                                const body = contentDoc.querySelector('body');
                                if (body) {
                                    htmlContent += body.innerHTML + '<div style="height: 40px;"></div>';
                                }
                            }
                        }
                    }
                    
                    if (!htmlContent) {
                        const allFiles = Object.keys(zip.files);
                        const htmlFiles = allFiles.filter(f => 
                            (f.endsWith('.html') || f.endsWith('.xhtml')) && 
                            !f.includes('nav.') && 
                            !f.includes('toc.')
                        );
                        
                        for (let filePath of htmlFiles) {
                            try {
                                const fileContent = await zip.file(filePath)?.async('string');
                                if (fileContent) {
                                    const parser = new DOMParser();
                                    const doc = parser.parseFromString(fileContent, 'text/html');
                                    const body = doc.querySelector('body');
                                    if (body) {
                                        htmlContent += body.innerHTML + '<div style="height: 40px;"></div>';
                                    }
                                }
                            } catch (e) {
                                console.error('Error reading file:', filePath, e);
                            }
                        }
                    }
                    
                    if (!htmlContent || htmlContent.trim().length < 50) {
                        throw new Error('No readable content found in EPUB file. The file may be encrypted or corrupted.');
                    }
                    
                    setContent(htmlContent);
                } catch (err) {
                    throw new Error(`Failed to load EPUB: ${err.message}`);
                }
            };

            return (
                <div style={{ 
                    minHeight: '100vh', 
                    background: '#ffffff',
                    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
                    display: 'flex',
                    flexDirection: 'column'
                }}>
                    <div style={{
                        background: '#f8f8f8',
                        borderBottom: '1px solid #e0e0e0',
                        padding: '8px 16px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '20px',
                        fontSize: '14px'
                    }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '20px' }}>
                            <span style={{ fontWeight: '500', cursor: 'pointer' }}>File</span>
                            <span style={{ cursor: 'pointer', color: '#666' }}>Edit</span>
                            <span style={{ cursor: 'pointer', color: '#666' }}>View</span>
                            <span style={{ cursor: 'pointer', color: '#666' }}>Insert</span>
                            <span style={{ cursor: 'pointer', color: '#666' }}>Format</span>
                            <span style={{ cursor: 'pointer', color: '#666' }}>Tools</span>
                            <span style={{ cursor: 'pointer', color: '#666' }}>Help</span>
                        </div>
                    </div>

                    <div style={{
                        background: '#fafafa',
                        borderBottom: '1px solid #e0e0e0',
                        padding: '8px 16px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between',
                        gap: '12px'
                    }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <button
                                onClick={() => setShowUpload(true)}
                                style={{
                                    padding: '6px 12px',
                                    background: 'white',
                                    border: '1px solid #d0d0d0',
                                    borderRadius: '3px',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    fontSize: '13px',
                                    color: '#333'
                                }}
                            >
                                <FolderOpen size={16} />
                                <span>Open</span>
                            </button>
                            <button
                                style={{
                                    padding: '6px 12px',
                                    background: 'white',
                                    border: '1px solid #d0d0d0',
                                    borderRadius: '3px',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    fontSize: '13px',
                                    color: '#333'
                                }}
                            >
                                <Save size={16} />
                                <span>Save</span>
                            </button>
                            
                            <div style={{ width: '1px', height: '24px', background: '#d0d0d0', margin: '0 4px' }}></div>
                            
                            <button
                                style={{
                                    padding: '6px 12px',
                                    background: 'white',
                                    border: '1px solid #d0d0d0',
                                    borderRadius: '3px',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    fontSize: '13px',
                                    color: '#333'
                                }}
                            >
                                <Copy size={16} />
                            </button>
                            <button
                                style={{
                                    padding: '6px 12px',
                                    background: 'white',
                                    border: '1px solid #d0d0d0',
                                    borderRadius: '3px',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    fontSize: '13px',
                                    color: '#333'
                                }}
                            >
                                <Printer size={16} />
                            </button>
                        </div>

                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            {content && fileType !== 'application/pdf' && !file?.name.toLowerCase().endsWith('.pdf') && (
                                <>
                                    <button
                                        onClick={() => setZoom(Math.max(50, zoom - 10))}
                                        style={{
                                            padding: '6px 10px',
                                            background: 'white',
                                            border: '1px solid #d0d0d0',
                                            borderRadius: '3px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            color: '#333'
                                        }}
                                    >
                                        <ZoomOut size={16} />
                                    </button>
                                    <span style={{ fontSize: '13px', color: '#666', minWidth: '50px', textAlign: 'center' }}>{zoom}%</span>
                                    <button
                                        onClick={() => setZoom(Math.min(200, zoom + 10))}
                                        style={{
                                            padding: '6px 10px',
                                            background: 'white',
                                            border: '1px solid #d0d0d0',
                                            borderRadius: '3px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            color: '#333'
                                        }}
                                    >
                                        <ZoomIn size={16} />
                                    </button>
                                </>
                            )}
                        </div>
                    </div>

                    {file && (
                        <div style={{
                            background: '#f0f0f0',
                            borderBottom: '1px solid #e0e0e0',
                            padding: '6px 16px',
                            fontSize: '12px',
                            color: '#666',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                        }}>
                            <FileText size={14} />
                            <span>{file.name}</span>
                            <span style={{ marginLeft: 'auto' }}>Read-only</span>
                        </div>
                    )}

                    <div style={{
                        flex: 1,
                        background: '#e8e8e8',
                        overflow: 'auto',
                        padding: '40px 20px'
                    }}>
                        {error && (
                            <div style={{
                                maxWidth: '800px',
                                margin: '0 auto 20px',
                                padding: '12px 16px',
                                background: '#fff3cd',
                                border: '1px solid #ffc107',
                                borderRadius: '4px',
                                display: 'flex',
                                alignItems: 'start',
                                gap: '10px'
                            }}>
                                <AlertCircle size={18} style={{ color: '#856404', flexShrink: 0 }} />
                                <div style={{ fontSize: '13px', color: '#856404' }}>{error}</div>
                            </div>
                        )}

                        {loading && (
                            <div style={{ 
                                maxWidth: '800px',
                                margin: '0 auto',
                                background: 'white',
                                borderRadius: '2px',
                                padding: '60px',
                                textAlign: 'center',
                                boxShadow: '0 1px 3px rgba(0,0,0,0.12)'
                            }}>
                                <div style={{
                                    display: 'inline-block',
                                    width: '40px',
                                    height: '40px',
                                    border: '4px solid #f3f3f3',
                                    borderTop: '4px solid #666',
                                    borderRadius: '50%',
                                    animation: 'spin 1s linear infinite'
                                }} />
                                <p style={{ marginTop: '20px', color: '#666', fontSize: '14px' }}>Loading document...</p>
                                <style>{`
                                    @keyframes spin {
                                        0% { transform: rotate(0deg); }
                                        100% { transform: rotate(360deg); }
                                    }
                                `}</style>
                            </div>
                        )}

                        {!content && !loading && !showUpload && (
                            <div style={{
                                maxWidth: '800px',
                                margin: '0 auto',
                                background: 'white',
                                borderRadius: '2px',
                                padding: '80px 40px',
                                textAlign: 'center',
                                boxShadow: '0 1px 3px rgba(0,0,0,0.12)'
                            }}>
                                <FileText size={64} style={{ color: '#ccc', marginBottom: '20px' }} />
                                <h2 style={{ margin: '0 0 10px 0', fontSize: '18px', color: '#333', fontWeight: '400' }}>
                                    No document open
                                </h2>
                                <p style={{ margin: '0 0 25px 0', color: '#999', fontSize: '14px' }}>
                                    Start by opening a document
                                </p>
                                <button
                                    onClick={() => setShowUpload(true)}
                                    style={{
                                        padding: '10px 24px',
                                        background: '#4a90e2',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '3px',
                                        cursor: 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    Open Document
                                </button>
                            </div>
                        )}

                        {showUpload && !content && (
                            <div style={{
                                maxWidth: '800px',
                                margin: '0 auto',
                                background: 'white',
                                borderRadius: '2px',
                                padding: '40px',
                                boxShadow: '0 1px 3px rgba(0,0,0,0.12)'
                            }}>
                                <h3 style={{ margin: '0 0 20px 0', fontSize: '16px', color: '#333', fontWeight: '500' }}>
                                    Open Document
                                </h3>
                                <label style={{
                                    display: 'block',
                                    border: '2px dashed #ccc',
                                    borderRadius: '4px',
                                    padding: '40px 30px',
                                    textAlign: 'center',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s ease',
                                    background: '#fafafa'
                                }}
                                onMouseEnter={(e) => {
                                    e.currentTarget.style.borderColor = '#4a90e2';
                                    e.currentTarget.style.background = '#f5f9fc';
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.borderColor = '#ccc';
                                    e.currentTarget.style.background = '#fafafa';
                                }}>
                                    <Upload size={40} style={{ color: '#999', marginBottom: '15px' }} />
                                    <div style={{ fontSize: '14px', fontWeight: '500', marginBottom: '8px', color: '#333' }}>
                                        Choose a file to open
                                    </div>
                                    <div style={{ color: '#999', fontSize: '13px' }}>
                                        Supported: PDF, EPUB
                                    </div>
                                    <input
                                        type="file"
                                        accept=".epub,.pdf,application/epub+zip,application/pdf"
                                        onChange={handleFileUpload}
                                        style={{ display: 'none' }}
                                    />
                                </label>
                                <div style={{ marginTop: '20px', textAlign: 'center' }}>
                                    <button
                                        onClick={() => setShowUpload(false)}
                                        style={{
                                            padding: '8px 20px',
                                            background: 'white',
                                            color: '#666',
                                            border: '1px solid #ccc',
                                            borderRadius: '3px',
                                            cursor: 'pointer',
                                            fontSize: '13px'
                                        }}
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        )}

                        {content && !loading && (
                            <div style={{
                                maxWidth: '800px',
                                margin: '0 auto',
                                background: 'white',
                                borderRadius: '2px',
                                padding: '60px 80px',
                                boxShadow: '0 1px 3px rgba(0,0,0,0.12)',
                                minHeight: '800px'
                            }}>
                                <div
                                    style={{
                                        fontSize: `${zoom}%`,
                                        lineHeight: '1.8',
                                        fontFamily: 'Georgia, "Times New Roman", serif',
                                        color: '#333'
                                    }}
                                    dangerouslySetInnerHTML={{ __html: content }}
                                />
                            </div>
                        )}
                    </div>

                    <div style={{
                        background: '#f0f0f0',
                        borderTop: '1px solid #d0d0d0',
                        padding: '4px 16px',
                        fontSize: '12px',
                        color: '#666',
                        display: 'flex',
                        justifyContent: 'space-between'
                    }}>
                        <span>Ready</span>
                        <span>UTF-8</span>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<BookViewer />, document.getElementById('root'));
    </script>
</body>
</html>
